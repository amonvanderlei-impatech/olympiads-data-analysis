---
title: "R Notebook"
output: html_notebook
---

Bibliotecas utilizadas

```{r, message=FALSE, warning=FALSE}
library(dplyr)
library(stringr)
library(tidyr)
library(janitor)
library(tidygeocoder)
```

Bases de dados: Historical Data from the Olympics
Disponíveis em: <https://basedosdados.org/dataset/62f8cb83-ac37-48be-874b-b94dd92d3e2b?table=567b1ccd-d8c2-4616-bacb-cf5c0e7b8d89>

```{r}
# Base de Dados 1: Resultados Atletas
resultados_atletas <- read.csv("Dados/world_olympedia_olympics_athlete_event_result.csv") %>%
  select(edition, edition_id, athlete_id, sport, country_noc, event, medal) %>%
  mutate(edition_id = as.numeric(edition_id),
         athlete_id = as.numeric(athlete_id),
         medal = na_if(medal, ""))

# Base de Dados 2: Bio Atletas
bio_atletas <- read.csv("Dados/world_olympedia_olympics_athlete_bio.csv") %>%
  select(athlete_id, sex, name) %>%
  mutate(athlete_id = as.numeric(athlete_id))

# União das Bases
dados_participacoes <- resultados_atletas %>%
  left_join(bio_atletas, by = "athlete_id")

rm(resultados_atletas, bio_atletas)
```

Alguns atletas não estão com suas informações contidas na segunda base de dados. Vamos adicionar manualmente essas informações.  
Os dados utilizados foram extraídos utilizando o id do atleta segundo a Olympedia.  
Disponível em: <https://www.olympedia.org/>

```{r}
# Dados Faltantes
dados_participacoes <- dados_participacoes %>% 
  mutate(name = case_when(
    athlete_id == 69534 ~ "John Thornton",
    athlete_id == 36110 ~ "Frank Courtney",
    athlete_id == 2302137 ~ "Peter Hunter Gaskell",
    athlete_id == 902283 ~ "Kay Todd, Jr.",
    athlete_id == 920957 ~ "Hoka Iwabuchi",
    athlete_id == 37833 ~ "Hans Joachim Hannemann",
    TRUE ~ name),
    sex = case_when(athlete_id %in% c(69534,36110,2302137,902283,920957,37833) ~ "Male",
                    TRUE ~ sex))
```

Ao analisar a base de dados acima, podemos encontrar casos de atletas com informações duplicadas. Essas "cópias" podem ser exatamente iguais (linhas duplicadas) ou pequenas variações.
Para remover essas cópias, vamos considerar que o atleta só pode participar em uma determinada edição, em uma determinada modalidade de um determinado esporte uma única vez, ou seja, um atleta não poderá representar mais de um país em uma mesma partida nem poderá obter mais de uma premiação. Para isso vamos selecionar a primeira aparição daquele dado em nosso dataframe.  
Observação: É importante garantir que caso o atleta tenha ganhado alguma premiação, nós não podemos correr o risco de selecionar uma cópia em que ele aparece sem premiação. Por esta razão é necessário ordenar nossos dados para que as cópias que indicam que houve premiação apareçam primeiro.

```{r}
# Remoção de "Duplicatas"
dados_participacoes <- dados_participacoes %>%
  arrange(athlete_id, edition_id, sport, event, medal) %>% 
  group_by(athlete_id, edition_id, sport, event) %>%
  slice(1) %>% 
  ungroup()
```

O Comitê Olímpico Internacional não reconhece as medalhas dos intercalados de 1906 como ificiais.

```{r}
# Remoção - Intercalados de 1906
dados_participacoes <- dados_participacoes %>% 
  filter(edition != "1906  Intercalated Games")
```

Para tornar nossa base de dados mais acessível, vamos traduzir o nome das colunas e algumas variáveis categóricas para o português.

```{r}
# Tradução
dados_participacoes <- dados_participacoes %>% 
  transmute(edicao_id = edition_id,
            ano = as.numeric(str_extract(edition, "\\d{4}")),
            estacao = case_when(str_detect(edition, "Summer") ~ "Verão",
                                str_detect(edition, "Equestrian") ~ "Verão",
                                str_detect(edition, "Winter") ~ "Inverno"),
            atleta_id = athlete_id,
            nome = name,
            pais_sg = country_noc,
            sexo = case_when(sex == "Male" ~ "Homem",
                             sex == "Female" ~"Mulher"),
            esporte = sport,
            modalidade = event,
            medalha = factor(medal,
                             level = c("Gold", "Silver", "Bronze"),
                             labels = c("Ouro", "Prata", "Bronze")))
```

Para adicionar o nome dos países vamos utilizar outra base de dados do mesmo grupo das duas primeiras.  
Disponível em: <https://basedosdados.org/dataset/62f8cb83-ac37-48be-874b-b94dd92d3e2b?table=567b1ccd-d8c2-4616-bacb-cf5c0e7b8d89>

```{r}
# Nomes por sigla
siglas_convercao <- read.csv("Dados/world_olympedia_olympics_country.csv") %>% 
  transmute(pais_sg = noc,
            pais = name) %>% 
  # Silga "ROC" duplicada no dataframe
  filter(!(pais == "ROC"))

dados_participacoes <- dados_participacoes %>%
  left_join(siglas_convercao, by = "pais_sg")
```
 
Agora os dados estão tratados e podem ser utilizados para nossa análise.

Exemplo: Quadro de medalhas por atleta.

```{r}
quadro_medalhas_atletas <- dados_participacoes %>%
  # Somente medalhistas
  filter(!is.na(medalha)) %>%
  # Divisão das medalhas por estação
  mutate(estacao_medalha = case_when(
    estacao == "Verão" ~ paste0("verao_", tolower(medalha)),
    estacao == "Inverno" ~ paste0("inverno_", tolower(medalha))
  )) %>%
  group_by(atleta_id, nome, estacao_medalha) %>%
  summarise(contagem = n(), .groups = "drop") %>%
  pivot_wider(names_from = estacao_medalha, 
              values_from = contagem, 
              values_fill = 0) %>%
  # Números totais de medalhas
  mutate(
    ouro   = rowSums(select(., any_of(c("verao_ouro", "inverno_ouro"))), na.rm = TRUE),
    prata  = rowSums(select(., any_of(c("verao_prata", "inverno_prata"))), na.rm = TRUE),
    bronze = rowSums(select(., any_of(c("verao_bronze", "inverno_bronze"))), na.rm = TRUE),
    # Totais por Estação
    total_verao = rowSums(select(., any_of(c("verao_ouro", "verao_prata", "verao_bronze"))), na.rm = TRUE),
    total_inverno = rowSums(select(., any_of(c("inverno_ouro", "inverno_prata", "inverno_bronze"))), na.rm = TRUE),
    # Total Absoluto
    total_geral = total_verao + total_inverno
  ) %>%
  # Reordenar as colunas
  select(atleta_id, nome,
         any_of(c("verao_ouro", "verao_prata", "verao_bronze", "total_verao")),
         any_of(c("inverno_ouro", "inverno_prata", "inverno_bronze", "total_inverno")),
         ouro, prata, bronze, total_geral) %>%
  arrange(desc(total_geral), desc(ouro), desc(prata), desc(bronze), desc(nome))
```

Se você quiser o número de medalhas por pais (considerando cada medalha entregue):

```{r}
quadro_medalhas_pais_atletas <- dados_participacoes %>%
  filter(!is.na(medalha)) %>%
  mutate(estacao_medalha = case_when(
    estacao == "Verão" ~ paste0("verao_", tolower(medalha)),
    estacao == "Inverno" ~ paste0("inverno_", tolower(medalha))
  )) %>%
  group_by(pais_sg, pais, estacao_medalha) %>%
  summarise(contagem = n(), .groups = "drop") %>%
  pivot_wider(names_from = estacao_medalha, 
              values_from = contagem, 
              values_fill = 0) %>%
  mutate(
    ouro   = rowSums(select(., any_of(c("verao_ouro", "inverno_ouro"))), na.rm = TRUE),
    prata  = rowSums(select(., any_of(c("verao_prata", "inverno_prata"))), na.rm = TRUE),
    bronze = rowSums(select(., any_of(c("verao_bronze", "inverno_bronze"))), na.rm = TRUE),
    total_verao = rowSums(select(., any_of(c("verao_ouro", "verao_prata", "verao_bronze"))), na.rm = TRUE),
    total_inverno = rowSums(select(., any_of(c("inverno_ouro", "inverno_prata", "inverno_bronze"))), na.rm = TRUE),
    total_geral = total_verao + total_inverno
  ) %>%
  select(pais_sg, pais, 
         any_of(c("verao_ouro", "verao_prata", "verao_bronze", "total_verao")),
         any_of(c("inverno_ouro", "inverno_prata", "inverno_bronze", "total_inverno")),
         ouro, prata, bronze, total_geral) %>%
  arrange(desc(ouro), desc(prata))
```

Por esse método de contagem o Brasil possui 144 medalhas de ouro.  
Agora, se você quiser o número de medalhas por país considerando apenas 1 medalha por time para jogos em grupo, o Brasil teria 37 medalhas de ouro.

```{r}
quadro_medalhas_pais_modalidades <- dados_participacoes %>%
  filter(!is.na(medalha)) %>%
  # Considerar apenas modalidades dintintas para cada edição
  distinct(edicao_id, pais_sg, pais, esporte, modalidade, medalha, estacao) %>% 
  mutate(estacao_medalha = case_when(
    estacao == "Verão" ~ paste0("verao_", tolower(medalha)),
    estacao == "Inverno" ~ paste0("inverno_", tolower(medalha))
  )) %>%
  group_by(pais_sg, pais, estacao_medalha) %>%
  summarise(contagem = n(), .groups = "drop") %>%
  pivot_wider(names_from = estacao_medalha, 
              values_from = contagem, 
              values_fill = 0) %>%
  mutate(
    ouro   = rowSums(select(., any_of(c("verao_ouro", "inverno_ouro"))), na.rm = TRUE),
    prata  = rowSums(select(., any_of(c("verao_prata", "inverno_prata"))), na.rm = TRUE),
    bronze = rowSums(select(., any_of(c("verao_bronze", "inverno_bronze"))), na.rm = TRUE),
    total_verao = rowSums(select(., any_of(c("verao_ouro", "verao_prata", "verao_bronze"))), na.rm = TRUE),
    total_inverno = rowSums(select(., any_of(c("inverno_ouro", "inverno_prata", "inverno_bronze"))), na.rm = TRUE),
    total_geral = total_verao + total_inverno
  ) %>%
  select(pais_sg, pais, 
         any_of(c("verao_ouro", "verao_prata", "verao_bronze", "total_verao")),
         any_of(c("inverno_ouro", "inverno_prata", "inverno_bronze", "total_inverno")),
         ouro, prata, bronze, total_geral) %>%
  arrange(desc(ouro), desc(prata))
```

Agora vamos pegar as coordenadas de cada cidade que sediou as olimpíadas. Para isso usaremos outra base de dados do conjunto.  
Disponível em: <https://basedosdados.org/dataset/62f8cb83-ac37-48be-874b-b94dd92d3e2b?table=567b1ccd-d8c2-4616-bacb-cf5c0e7b8d89>

```{r}
dados_latlong <- read.csv("Dados/world_olympedia_olympics_game.csv") %>% 
  filter(edition != "1906 Intercalated") %>% 
  mutate(edicao_id = edition_id,
         ano = as.numeric(str_extract(edition, "\\d{4}")),
         estacao = case_when(str_detect(edition, "Summer") ~ "Verão",
                             str_detect(edition, "Equestrian") ~ "Verão",
                             str_detect(edition, "Winter") ~ "Inverno"),
         cidade = case_when(city == "Milano-Cortina d'Ampezzo" ~ "Cortina d'Ampezzo",
                          TRUE ~ city),
         pais_sg = country_noc,
         bandeira_url = country_flag_url) %>% 
  geocode(city = cidade, method = 'osm', lat = latitude , long = longitude) %>% 
  left_join(siglas_convercao, by = "pais_sg") %>% 
  select(edicao_id, ano, estacao, cidade, pais_sg, pais, bandeira_url, latitude, longitude)
```

Vamos criar algumas paletas de cores baseadas em cartazes e ilustrações de diferentes olimpíadas ao longo do tempo:

```{r}
paleta1 <- c("#07598C", "#F2A413", "#A63B32", "#BF491F", "#F0EADC") # França Inverno 1924

paleta2 <- c("#012340", "#025E73", "#D9A404", "#D97904", "#D9C5A0") # França Inverno 1924

paleta3 <- c("#3E4649", "#7897BF", "#A6294B", "#D9593D", "#F2EFDF") # França Inverno 1924

paleta4 <- c("#3285A6", "#4694A6", "#D97904", "#D96704", "#A60D0D") # França Inverno 1924

paleta5 <- c("#BF0B1A", "#EEC50B", "#065473", "#157A74", "#F1F3E5") # Suiça Inverno 1928

paleta6 <- c("#0E4459", "#1F6373", "#E09714", "#BF1717", "#F2E5D5") # EUA Verão 1932

paleta7 <- c("#040B11", "#2D2273", "#F2D544", "#D91111", "#F2E8DC") # Alemanha Inverno 1936

paleta8 <- c("#001D2D", "#037F8C", "#F2C335", "#BF3C1F", "#D9C6B0") # Itália Inverno 1956

paleta9 <- c("#0D0F1B", "#263F8C", "#F2CE1B", "#D92211", "#F2F0EB") # Itália Inverno 1956

paleta10 <- c("#2C2C24", "#0367A6", "#0378A6", "#D91E0D", "#F2F2EB") # Canadá Verão 1976

paleta11 <- c("#0477BF", "#1AA3D9", "#F2F2EB", "#F2CE16", "#F29F05") # Canadá Verão 1976
```
